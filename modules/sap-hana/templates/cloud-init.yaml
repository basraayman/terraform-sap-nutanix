#cloud-config
# Cloud-init configuration for SAP HANA VM
# This template is used to configure the guest OS on first boot

hostname: ${hostname}
fqdn: ${hostname}.local
manage_etc_hosts: true

# Timezone configuration
timezone: ${timezone}

# SSH configuration
ssh_pwauth: false
disable_root: false

# SSH authorized keys
%{ if length(ssh_authorized_keys) > 0 ~}
ssh_authorized_keys:
%{ for key in ssh_authorized_keys ~}
  - ${key}
%{ endfor ~}
%{ endif ~}

# Package management
package_update: true
package_upgrade: false
package_reboot_if_required: false

# Install additional packages
packages:
  - tuned
  - chrony
  - rsyslog
  - net-tools
%{ if length(additional_packages) > 0 ~}
%{ for package in additional_packages ~}
  - ${package}
%{ endfor ~}
%{ endif ~}

# Write files for SAP HANA configuration hints
write_files:
  - path: /etc/sap_deployment_info.txt
    permissions: '0644'
    content: |
      SAP System Type: HANA
      SAP SID: ${hana_sid}
      Instance Number: ${hana_instance_number}
      Deployment Date: $(date)
      Deployed by: Terraform
  
  - path: /etc/sysctl.d/sap.conf
    permissions: '0644'
    content: |
      # SAP HANA kernel parameters placeholder
      # These should be configured by your configuration management tool
      # Based on SAP Note 2382421 and 2015553
      
  - path: /etc/security/limits.d/99-sap.conf
    permissions: '0644'
    content: |
      # SAP HANA resource limits placeholder
      # Configure via configuration management

# Run commands on first boot
runcmd:
  - echo "SAP HANA VM initialization started" >> /var/log/cloud-init-sap.log
  - systemctl enable chronyd
  - systemctl start chronyd
  - echo "Cloud-init configuration complete" >> /var/log/cloud-init-sap.log

# Final message
final_message: "SAP HANA VM ${hostname} is ready. Duration: $UPTIME seconds"

